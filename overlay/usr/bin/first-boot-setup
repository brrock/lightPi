#!/bin/sh

CONFIG_FILE="/lightPi.txt"
MARKER_FILE="/etc/first-boot-done"

# --- Check if this is the first boot ---
if [ -f "$MARKER_FILE" ]; then
  echo "âœ… First boot setup already completed. Skipping."
  exit 0
fi

# --- Check if config file exists ---
if [ ! -f "$CONFIG_FILE" ]; then
  echo "âŒ Config file $CONFIG_FILE not found. Exiting."
  exit 1
fi

# --- Load config ---
echo "ğŸ“„ Loading config from $CONFIG_FILE..."
source "$CONFIG_FILE"

# --- Set Locale ---
if [ -n "$LOCALE" ]; then
  echo "ğŸŒ Configuring locale: $LOCALE"
  
  # Enable the locale in /etc/locale.gen if not already enabled
  if grep -q "^# *$LOCALE" /etc/locale.gen; then
    echo "ğŸ”§ Enabling $LOCALE in /etc/locale.gen"
    sed -i "s/^# *\($LOCALE\)/\1/" /etc/locale.gen
  elif ! grep -q "^$LOCALE" /etc/locale.gen; then
    echo "â• Adding $LOCALE to /etc/locale.gen"
    echo "$LOCALE UTF-8" >> /etc/locale.gen
  fi

  echo "ğŸ› ï¸ Running locale-gen..."
  locale-gen

  echo "ğŸŒ Setting system locale to $LOCALE"
  echo "LANG=$LOCALE" > /etc/locale.conf
else
  echo "âš ï¸ LOCALE not specified. Skipping locale setup."
fi

# --- Set Hostname (Arch-style) ---
if [ -n "$HOSTNAME" ]; then
  echo "ğŸ–¥ï¸ Setting hostname to $HOSTNAME"
  echo "$HOSTNAME" > /etc/hostname  # Simpler way for arch
  sed -i "s/127.0.0.1.*/127.0.0.1   $HOSTNAME localhost/" /etc/hosts
else
  echo "âš ï¸ HOSTNAME not specified. Skipping hostname setup."
fi

# --- Set Timezone ---
if [ -n "$TIMEZONE" ]; then
  echo "ğŸ•’ Setting timezone to $TIMEZONE"
  ln -sf "/usr/share/zoneinfo/$TIMEZONE" /etc/localtime
else
  echo "âš ï¸ TIMEZONE not specified. Skipping timezone setup."
fi

# --- Network Setup (if nmcli is available) ---
if command -v nmcli >/dev/null 2>&1; then
  echo "ğŸ“¡ NetworkManager is available."

  case "$NETWORK_TYPE" in
    wifi)
      if [ -n "$WIFI_SSID" ] && [ -n "$WIFI_PASSWORD" ]; then
        echo "ğŸ“¶ Connecting to Wi-Fi: $WIFI_SSID"
        nmcli device wifi connect "$WIFI_SSID" password "$WIFI_PASSWORD" || {
          echo "âŒ Failed to connect to Wi-Fi."
        }
      else
        echo "âš ï¸ WIFI_SSID or WIFI_PASSWORD missing. Skipping Wi-Fi setup."
      fi
      ;;
    ethernet)
      echo "ğŸ”Œ Connecting via Ethernet (DHCP)"
      nmcli device connect eth0 || {
        echo "âŒ Failed to bring up Ethernet."
      }
      ;;
    *)
      echo "âš ï¸ Unknown NETWORK_TYPE: $NETWORK_TYPE. Skipping network setup."
      ;;
  esac
else
  echo "âš ï¸ nmcli not found. Skipping network setup."
fi
# --- Create user and delete default 'arch' user ---
if [ -n "$NEW_USERNAME" ] && [ -n "$NEW_PASSWORD" ]; then
  echo "ğŸ‘¤ Creating new user: $NEW_USERNAME"

  # Create user with home directory
  useradd -m -G wheel -s /bin/bash "$NEW_USERNAME"

  # Set password
  echo "$NEW_USERNAME:$NEW_PASSWORD" | chpasswd

  # Ensure sudo is available and wheel group has sudo rights
  if command -v sudo >/dev/null 2>&1; then
    echo "ğŸ›¡ï¸ Granting sudo access to $NEW_USERNAME"
    sed -i 's/^# %wheel ALL=(ALL:ALL) ALL/%wheel ALL=(ALL:ALL) ALL/' /etc/sudoers
  else
    echo "âš ï¸ sudo not found. Install it manually if needed."
  fi

  # Remove default 'arch' user
  if id "arch" >/dev/null 2>&1; then
    echo "ğŸ—‘ï¸ Removing default 'arch' user..."
    userdel -r alarm
  else
    echo "â„¹ï¸ Default 'arch' user not found. Skipping removal."
  fi
else
  echo "âš ï¸ NEW_USERNAME or NEW_PASSWORD not specified. Skipping user creation and deletion."
fi

# --- Finalize ---
touch "$MARKER_FILE"
echo "âœ… First boot setup complete."

